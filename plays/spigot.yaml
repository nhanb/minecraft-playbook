---
# As instructed in http://www.spigotmc.org/wiki/spigot-installation/#linux

- name: install git
  apt: pkg=git state=latest

- name: install tar
  apt: pkg=tar state=latest

- name: install tmux
  apt: pkg=tmux state=latest

- name: create dir to store BuildTools and all the stuff it downloads/compiles
  file: dest={{ src_dir }} mode=755 state=directory

- name: download BuildTools
  get_url: url=https://hub.spigotmc.org/jenkins/job/BuildTools/lastSuccessfulBuild/artifact/target/BuildTools.jar
    dest={{ src_dir }}/BuildTools.jar

- name: run BuildTools to compile Spigot (will take a while)
  command: java -jar BuildTools.jar chdir={{ src_dir }}/

- name: create dir to store production server
  file: dest={{ prod_dir }} mode=755 state=directory

- name: get spigot jar file path
  shell: ls {{ src_dir }}/Spigot/Spigot-Server/target/spigot-*-SNAPSHOT.jar
  register: spigot_jar

- name: move compiled server jar to production dir
  command: cp {{ spigot_jar.stdout }} {{ prod_dir }}/spigot.jar

- name: create startup script
  template: src=start.sh dest={{ prod_dir }}/start.sh mode=0744

- name: create tmux script
  template: src=tmux.sh dest={{ prod_dir }}/tmux.sh mode=0744

- name: kick off server in a tmux session
  command: ./tmux.sh chdir={{ prod_dir }}
